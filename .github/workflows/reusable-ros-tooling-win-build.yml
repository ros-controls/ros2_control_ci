name: Reusable Windows Binary Build
# author: Christoph Froehlich <christoph.froehlich@ait.ac.at>

on:
  workflow_call:
    inputs:
      ros_distro:
        description: 'ROS 2 distribution name, e.g. rolling'
        required: true
        type: string
      ref_for_scheduled_build:
        description: 'Reference on which the repo should be checkout for scheduled build. Usually is this name of a branch or a tag.'
        default: ''
        required: false
        type: string
      os_name:
        description: 'On which OS to run the build job'
        required: false
        default: 'windows-2025'
        type: string
      container:
        description: '(optional) Docker container to run the job in, e.g. ubuntu:noble'
        required: false
        default: ''
        type: string
      windows_dependencies:
        description: 'Path to a repos file with additional windows dependencies'
        required: false
        default: ''
        type: string
      install_boost:
        description: 'Install boost for the build'
        required: false
        default: false
        type: boolean
      skip_packages:
        description: 'Packages to skip from build and test'
        default: ''
        required: false
        type: string
      skip_packages_test:
        description: 'Packages to skip from test additionally to skip_packages'
        default: ''
        required: false
        type: string

jobs:
  reusable_ros_tooling_source_build:
    name: ${{ inputs.ros_distro }} ${{ inputs.os_name }}
    runs-on: ${{ inputs.os_name }}
    container: ${{ inputs.container }}
    env:
      # this will be src/{repo-owner}/{repo-name}
      repo_path: src/${{ github.repository }}
    steps:
      - name: Bootstrap pixi
        # https://docs.ros.org/en/rolling/Installation/Windows-Install-Binary.html
        run: |
          irm https://raw.githubusercontent.com/ros2/ros2/refs/heads/rolling/pixi.toml -OutFile pixi.toml

      - uses: prefix-dev/setup-pixi@v0.8.8
        with:
          manifest-path: pixi.toml
          cache: true

      - name: Install ROS
        # https://docs.ros.org/en/rolling/Installation/Windows-Install-Binary.html
        run: |
          # Download and extract ROS 2 package
          $url = "https://ci.ros2.org/view/packaging/job/packaging_windows-2025/lastSuccessfulBuild/artifact/ws/ros2-package-windows-AMD64.zip"
          $output = "ros2-package-windows-AMD64.zip"
          Invoke-WebRequest -Uri $url -OutFile $output
          Expand-Archive -Path $output -DestinationPath ros2_${{ inputs.ros_distro }}

      - name: Checkout default ref when build is not scheduled
        if: ${{ github.event_name != 'schedule' }}
        uses: actions/checkout@v4
        with:
          path: ${{ env.repo_path }}
      - name: Checkout ${{ inputs.ref_for_scheduled_build }} on scheduled build
        if: ${{ github.event_name == 'schedule' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref_for_scheduled_build }}
          path: ${{ env.repo_path }}

      - id: package_list_action
        uses: ros-controls/ros2_control_ci/.github/actions/set-package-list-pixi@windows/pixi
        with:
          path: ${{ env.repo_path }}

      - name: Check for local repos file
        id: check_local_repos
        run: |
          if (Test-Path ${{ env.repo_path }}\${{ steps.package_list_action.outputs.repo_name }}.${{ inputs.ros_distro }}.repos) {
              Write-Output "Local repos file found"
              "repo_file=${{ env.repo_path }}\${{ steps.package_list_action.outputs.repo_name }}.${{ inputs.ros_distro }}.repos" | Out-File -FilePath $Env:GITHUB_OUTPUT -Append
          } else {
            Write-Output "No local repos file found"
            "repo_file=" | Out-File -FilePath $Env:GITHUB_OUTPUT -Append
          }
          if (![string]::IsNullOrWhiteSpace("${{ inputs.windows_dependencies }}") -and (Test-Path "${{ env.repo_path }}\${{ inputs.windows_dependencies }}")) {
            Write-Output "Windows repos file found"
            "repo_file=${{ env.repo_path }}\${{ inputs.windows_dependencies }}" | Out-File -FilePath $Env:GITHUB_OUTPUT -Append
          } else {
            Write-Output "No windows dependencies provided or file not found"
            "repo_file=" | Out-File -FilePath $Env:GITHUB_OUTPUT -Append
          }

      - name: Install dependencies
        shell: pixi run pwsh -Command {0}
        run: |
          if (![string]::IsNullOrWhiteSpace("${{ steps.check_local_repos.outputs.repo_files }}")) {
            vcs import --input ${{ env.repo_path }}/${{ steps.check_local_repos.outputs.repo_file }} src
          }
          if (![string]::IsNullOrWhiteSpace("${{ steps.check_local_repos.outputs.repo_file }}")) {
            vcs import --input ${{ env.repo_path }}/${{ steps.check_local_repos.outputs.repo_file }} src
          }

      - name: Build workspace
        run: |
          pixi run & ros2_${{ inputs.ros_distro }}\local_setup.bat
          pixi run colcon build --packages-up-to ${{ steps.package_list_action.outputs.package_list }} --packages-skip ${{ inputs.skip_packages }}
          pixi run echo "Build succeeded"

      - name: Test workspace
        shell: pixi run pwsh -Command {0}
        run: |
          & ros2_${{ inputs.ros_distro }}\local_setup.bat
          colcon test --executor sequential --packages-select ${{ steps.package_list_action.outputs.package_list }} --packages-skip ${{ inputs.skip_packages }} ${{ inputs.skip_packages_test }}
          colcon test-result --verbose
          echo "Tests succeeded"

      - name: Download issue template for target failure  # Has to be a local file
        if: ${{ always() && steps.action-ros.outcome == 'failure' && github.event_name == 'schedule' }}
        run:
          wget https://raw.githubusercontent.com/ros-controls/ros2_control_ci/master/.github/issue_template_failed_ci.md -O ${{ env.repo_path }}/.github/issue_template_failed_ci.md
      - uses: JasonEtco/create-an-issue@v2
        # action-ros-ci does not report more details on test failures afaik
        if: ${{ always() && steps.action-ros.outcome == 'failure' && github.event_name == 'schedule'}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ACTION_NAME: ${{ inputs.ros_distro }}/source
          REF: ${{ inputs.ref_for_scheduled_build }}
          URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          update_existing: true
          filename: ${{ env.repo_path }}/.github/issue_template_failed_ci.md
